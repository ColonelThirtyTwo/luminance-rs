# Links

- [#303](https://github.com/phaazon/luminance-rs/issues/304)

# Study

Because of how objects are created, it can be possible that someone tries to keep around some objects created
_after_ the context. In that situation, dropping those objects after the context was disposed of is a segfault.

To solve that problem, we could keep the context as a shared pointer with all objects. Iâ€™m not a huge fan of that
though, because it means that we will not really know when the object will be disposed of.

The problem is `Drop`. Because we need to have the context around to be able to use an object (some exceptions exist),
we could duplicate the backend object. That means that the context would have the list of all existing objects. When we
drop the context, it should go through that list and destroys everything. When we are in the `Drop` of e.g. `Buffer`, we
need to check whether the resource still exist, and if so, delete it.

The way it would work would be to wrap low-level backend handles into a wrapper type that would do the check in its
`Drop` implementation. However, to perform that check, we need something that is shared and mutable, unfortunately.
Something like a `Rc<RefCell<_>>`.

```rust
struct BackendHandle<B: Backend, T> {
  handle: Rc<RefCell<Option<T>>>,
  state: Rc<RefCell<B::State>>,
}

impl<B: Backend, T: BackendDrop<B::State>> Drop for BackendHandle<B, T> {
  fn drop(&mut self) {
    let state_ref = self.state.borrow_mut();
    let handle_ref = self.handle.borrow_mut();
    // check if the state still exists
    if let Some(state) = state_ref {
      // check if the resource still exists
      if let Some(handle) = handle_ref {
        handle.backend_drop(state);

        *state_ref = None;
        *handle_ref = None;
      }
    }
  }
}
```

Something like that. When we drop a context, it will drop all of its `BackendHandle` so the resources will be disposed
of. In the `Drop` implementation of each and every resource, we will then not drop them again.

The problem with that approach is the runtime check on whether or not the resource still exists.
